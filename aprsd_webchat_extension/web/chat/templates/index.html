<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <title>APRSD WebChat - {{ callsign }}</title>
    <script src="/static/js/upstream/jquery-3.7.1.min.js"></script>
    <script src="/static/js/upstream/jquery.toast.js"></script>
    <script src="/static/js/upstream/jquery.timeago.min.js"></script>
    <script src="/static/js/upstream/socket.io.min.js"></script>

    <link rel="stylesheet" href="/static/css/upstream/bootstrap.min.css">
    <script defer src="/static/js/upstream/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="/static/css/upstream/google-fonts.css">
    <link rel="stylesheet" href="/static/css/upstream/jquery.toast.css">

    <link rel="stylesheet" href="/static/css/chat.css">
    <link rel="stylesheet" href="/static/css/index.css">
    <link rel="stylesheet" href="/static/css/tabs.css">

    <!-- Set theme immediately to prevent flash -->
    <script>
        (function() {
            const theme = localStorage.getItem('aprsd-webchat-theme') ||
                         (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>

    <script src="/static/js/theme.js"></script>
    <script src="/static/js/main.js"></script>
    <script src="/static/js/gps.js"></script>
    <script src="/static/js/send-message.js"></script>
    <script src="/static/js/tour.js"></script>

    <script type="text/javascript">
        var initial_stats = {{ initial_stats|tojson|safe }};
        var gps_lat = '{{ initial_stats.stats.GPSStats.latitude|safe }}';
        var gps_lon = '{{ initial_stats.stats.GPSStats.longitude|safe }}';
        var gps_alt = '{{ initial_stats.stats.GPSStats.altitude|safe }}';
        var gps_speed = parseFloat('{{ initial_stats.stats.GPSStats.speed|safe }}');
        var gps_course = parseFloat('{{ initial_stats.stats.GPSStats.track|safe }}');
        var is_digipi = '{{ initial_stats.is_digipi|safe }}';
        var beaconing_enabled = '{{ beaconing_enabled|safe }}';
        // set the cutoff time for the timeago plugin to 6 days
        jQuery.timeago.settings.cutoff = 1000*60*60*24*6;

        // now set the values of the gps_lat, gps_lon, gps_alt, gps_speed, and gps_course in the initial_stats.
        // convert meters per second to kilometers per hour
        var speed_kph = gps_speed * 3.6;

        // 0 is disabled, 1 is manual enabled, 2 is interval beaconing and 3 is smart beaconing.
        var beaconing_setting = 0;

        $(document).ready(function() {
            //console.log(initial_stats);
            start_update();
            init_chat();
            //reset_Tabs();
            // Have to call it in init_chat() because the socketio connection is not established yet.
            //init_gps();

            $('#gps_lat').text(gps_lat);
            $('#gps_lon').text(gps_lon);
            $('#gps_alt').text(gps_alt);
            $('#gps_speed').text(Math.floor(speed_kph) + "km/h");
            $('#gps_course').text(Math.floor(gps_course) + "Â°");

            $("#wipe_local").click(function() {
                console.log('Wipe local storage');
                localStorage.clear();
            });

            // Tour restart button - use document ready to ensure tour.js is loaded
            $(document).ready(function() {
                $("#tour-restart-button").on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    console.log('Tour button clicked');
                    console.log('window.aprsdTour:', typeof window.aprsdTour);

                    // Function to start tour
                    function startTourNow() {
                        if (typeof window.aprsdTour !== 'undefined') {
                            console.log('Tour object found, calling reset');
                            if (window.aprsdTour.reset) {
                                window.aprsdTour.reset();
                            } else if (window.aprsdTour.start) {
                                window.aprsdTour.start();
                            } else {
                                console.error('Tour functions not available');
                            }
                        } else {
                            console.warn('Tour script not loaded, waiting...');
                            // Wait a bit more and try again
                            setTimeout(function() {
                                if (typeof window.aprsdTour !== 'undefined' && window.aprsdTour.reset) {
                                    console.log('Tour object found after wait, calling reset');
                                    window.aprsdTour.reset();
                                } else {
                                    console.error('Tour script still not loaded');
                                }
                            }, 500);
                        }
                    }

                    // Try immediately
                    startTourNow();
                });
            });

            // iPhone-style message input behavior
            var messageInput = $('#message');
            var sendButton = $('#send_msg');

            // Enable/disable send button based on input
            function updateSendButton() {
                var hasText = messageInput.val().trim().length > 0;
                var hasCallsign = selected_tab_callsign && selected_tab_callsign !== null && selected_tab_callsign !== '';
                sendButton.prop('disabled', !hasText || !hasCallsign);
            }

            // Update on input
            messageInput.on('input', function() {
                updateSendButton();
            });

            // Initial state
            updateSendButton();

            // Make updateSendButton available globally
            window.updateSendButton = updateSendButton;


            // Save path when user manually changes it
            $('#pkt_path').on('change', function() {
                if (selected_tab_callsign && selected_tab_callsign !== '') {
                    var path = $(this).val();
                    if (typeof callsign_list !== 'undefined') {
                        callsign_list[selected_tab_callsign] = path || '';
                        if (typeof save_data === 'function') {
                            save_data();
                        }
                    }
                }
            });

            // Auto-focus message input when tab is selected (but not the "+" tab)
            // Also restore the path for the selected callsign
            $(document).on('shown.bs.tab', 'button[data-bs-toggle="tab"]', function (e) {
                var callsign = $(e.target).attr('callsign');
                if (callsign && callsign !== 'ADD_TAB') {
                    // Restore the path for this callsign
                    if (typeof callsign_list !== 'undefined' && callsign in callsign_list && callsign_list[callsign]) {
                        $('#pkt_path').val(callsign_list[callsign]);
                    } else {
                        $('#pkt_path').val('');
                    }
                    setTimeout(function() {
                        messageInput.focus();
                    }, 100);
                } else if (callsign === 'ADD_TAB') {
                    setTimeout(function() {
                        $('#new-callsign-input').focus();
                    }, 100);
                }
            });

            //Now send a message back to the server when the user changes the beaconing setting.
            $('#save_beacon_settings').click(function() {
                beacon_type = $('#beaconing_setting').val();
                gps_settings = {
                    'beacon_type': beacon_type,
                    'beacon_interval': $('#beacon_interval').val(),
                    'smart_beacon_distance_threshold': $('#smart_beacon_distance_threshold').val(),
                    'smart_beacon_time_window': $('#smart_beacon_time_window').val(),
                }
                console.log("Sending beaconing settings to server", gps_settings);
                socket.emit('set_beaconing_setting', gps_settings);
                $.toast({heading: 'Beaconing Settings Saved',
                        text: "Beaconing settings saved",
                        loader: true,
                        loaderBg: '#9EC600',
                        position: 'top-center',
                });
            });

            // When a tab is clicked, update selected_tab_callsign
            $(document).on('shown.bs.tab', 'button[data-bs-toggle="tab"]', function (e) {
                var tab = $(e.target);
                var callsign = tab.attr("callsign");
                if (callsign && callsign !== 'ADD_TAB') {
                    selected_tab_callsign = callsign;
                    updateSendButton();
                    // Auto-focus message input when a callsign tab is selected
                    setTimeout(function() {
                        $('#message').focus();
                    }, 100);
                } else if (callsign === 'ADD_TAB') {
                    // Focus the new callsign input when "+" tab is selected
                    setTimeout(function() {
                        $('#new-callsign-input').focus();
                    }, 100);
                }
            });

            // set initial opacity of the radio icon to 0.2
            $('#radio_icon_svg').css('opacity', 0.2);

            /*$('[data-bs-toggle="popover"]').popover(
                {html: true, animation: true}
            );*/
            reload_popovers();

            $('#myModal').on('shown.bs.modal', function () {
                $('#myInput').trigger('focus')
            })
            //$("time.timeago").timeago();
        });
    </script>
</head>

<body>
    <div class="wc-container">
        <header class="wc-header">
            <div class="container-fluid">
                <div class="header-top">
                    <div class="header-title-row">
                        <h1 class="app-title">APRSD WebChat</h1>
                        <div class="theme-toggle-container">
                            <button type="button" class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                                <span class="material-symbols-rounded light-icon">light_mode</span>
                                <span class="material-symbols-rounded dark-icon">dark_mode</span>
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary btn-gps" data-bs-toggle="collapse" href="#collapseGPS" role="button" aria-expanded="false" aria-controls="collapseGPS">
                                <img src="/static/images/satellite-solid.svg" id="gps_icon" class="gps-satellite-icon" alt="GPS" width="20" height="20">
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary btn-tour" id="tour-restart-button" aria-label="Start tour" title="Start tour">
                                <span class="material-symbols-rounded">help</span>
                            </button>
                        </div>
                    </div>
                    {% if is_digipi == False %}
                    <div class="connection-info">
                        <span class="callsign-badge">{{ callsign }}</span>
                        <span class="connection-text">connected to</span>
                        <span class="connection-link" id='aprs_connection'>{{ aprs_connection|safe }}</span>
                    </div>
                    {% endif %}
                </div>

                <div class="collapse gps-panel" id="collapseGPS">
                    <div class="gps-card">
                        <div class="gps-header">
                            <h3>GPS & Beaconing</h3>
                        </div>
                        <div class="gps-body">
                            <div id="gps_info_box" class="gps-info">
                                <div class="gps-info-item">
                                    <span class="gps-label">Latitude:</span>
                                    <span class="gps-value" id="gps_lat">-</span>
                                </div>
                                <div class="gps-info-item">
                                    <span class="gps-label">Longitude:</span>
                                    <span class="gps-value" id="gps_lon">-</span>
                                </div>
                                <div class="gps-info-item">
                                    <span class="gps-label">Altitude:</span>
                                    <span class="gps-value" id="gps_alt">-</span>
                                </div>
                                <div class="gps-info-item">
                                    <span class="gps-label">Speed:</span>
                                    <span class="gps-value" id="gps_speed">-</span>
                                </div>
                                <div class="gps-info-item">
                                    <span class="gps-label">Course:</span>
                                    <span class="gps-value" id="gps_course">-</span>
                                </div>
                                <div class="gps-info-item">
                                    <span class="gps-label">Updated:</span>
                                    <span class="gps-value"><time id="gps_timeago" class="timeago" datetime="0"></time></span>
                                </div>
                            </div>

                            <div class="beaconing-controls">
                                <label for="beaconing_setting" class="form-label">
                                    Beaconing Mode: <span id="beaconing_setting_description" class="beaconing-desc">-</span>
                                </label>
                                <input type="range" class="form-range beaconing-slider" min="0" max="3" step="1" id="beaconing_setting">
                                <script>
                                    $('#beaconing_setting').on('input', function() {
                                        var value = $(this).val();
                                        set_beaconing_setting(value);
                                    });
                                </script>

                                <div class="beaconing-options">
                                    <div class="form-group" id="beacon_interval_group" style="display: none;">
                                        <label for="beacon_interval" id="beacon_interval_label" class="form-label">Beacon Interval (seconds)</label>
                                        <input type="number" class="form-control" id="beacon_interval" placeholder="1800" value="{{ initial_stats.stats.gps.gps_extension.beacon_interval|default(1800) }}">
                                    </div>
                                    <div class="form-group" id="smart_beacon_time_window_group" style="display: none;">
                                        <label for="smart_beacon_time_window" id="smart_beacon_time_window_label" class="form-label">Time Window (seconds)</label>
                                        <input type="number" class="form-control" id="smart_beacon_time_window" placeholder="600">
                                    </div>
                                    <div class="form-group" id="smart_beacon_distance_threshold_group" style="display: none;">
                                        <label for="smart_beacon_distance_threshold" id="smart_beacon_distance_threshold_label" class="form-label">Distance Threshold (meters)</label>
                                        <input type="number" class="form-control" id="smart_beacon_distance_threshold" placeholder="100">
                                    </div>
                                </div>

                                <div class="beaconing-actions">
                                    <button type="button" class="btn btn-primary" id="send_beacon">
                                        <span class="material-symbols-rounded">location_on</span>
                                        Send Beacon
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="save_beacon_settings">
                                        <span class="material-symbols-rounded">save</span>
                                        Save Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tabs-container">
                    <ul class="nav nav-tabs modern-tabs" id="msgsTabList" role="tablist"></ul>
                </div>
            </div>
        </header>

        <div class="wc-info-bar">
            <div class="container-fluid">
                <div class="info-bar-content">
                    <div id="info_bar_container" class="info-message">
                        <span id="welcome_message">Welcome to APRSD WebChat. Click the <strong>+</strong> tab above to add a callsign and start chatting.</span>
                    </div>
                    <div class="radio-indicator">
                        <svg id="radio_icon_svg" width="24" height="24" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M2.998 5.58a5.55 5.55 0 0 1 1.62-3.88l-.71-.7a6.45 6.45 0 0 0 0 9.16l.71-.7a5.55 5.55 0 0 1-1.62-3.88zm1.06 0a4.42 4.42 0 0 0 1.32 3.17l.71-.71a3.27 3.27 0 0 1-.76-1.12 3.45 3.45 0 0 1 0-2.67 3.22 3.22 0 0 1 .76-1.13l-.71-.71a4.46 4.46 0 0 0-1.32 3.17zm7.65 3.21l-.71-.71c.33-.32.59-.704.76-1.13a3.449 3.449 0 0 0 0-2.67 3.22 3.22 0 0 0-.76-1.13l.71-.7a4.468 4.468 0 0 1 0 6.34zM13.068 1l-.71.71a5.43 5.43 0 0 1 0 7.74l.71.71a6.45 6.45 0 0 0 0-9.16zM9.993 5.43a1.5 1.5 0 0 1-.245.98 2 2 0 0 1-.27.23l3.44 7.73-.92.4-.77-1.73h-5.54l-.77 1.73-.92-.4 3.44-7.73a1.52 1.52 0 0 1-.33-1.63 1.55 1.55 0 0 1 .56-.68 1.5 1.5 0 0 1 2.325 1.1zm-1.595-.34a.52.52 0 0 0-.25.14.52.52 0 0 0-.11.22.48.48 0 0 0 0 .29c.04.09.102.17.18.23a.54.54 0 0 0 .28.08.51.51 0 0 0 .5-.5.54.54 0 0 0-.08-.28.58.58 0 0 0-.23-.18.48.48 0 0 0-.29 0zm.23 2.05h-.27l-.87 1.94h2l-.86-1.94zm2.2 4.94l-.89-2h-2.88l-.89 2h4.66z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <main class="wc-content" id="wc-content">
            <div class="container-fluid">
                <div class="tab-content" id="msgsTabContent"></div>
            </div>
            <!-- iPhone-style message input at bottom -->
            <div class="message-input-container">
                <form class="message-input-form" id="sendform" name="sendmsg" action="" autocomplete="off">
                    <div class="message-input-wrapper">
                        <input type="text"
                               class="message-input"
                               name="message"
                               id="message"
                               maxlength="67"
                               placeholder="Message"
                               autocomplete="off"
                               spellcheck="true">
                        <select class="message-path-select" name="pkt_path" id="pkt_path" aria-label="Message path">
                            <option value="" disabled selected>Path</option>
                            <option value="WIDE1-1">WIDE1-1</option>
                            <option value="WIDE1-1,WIDE2-1">WIDE1-1,WIDE2-1</option>
                            <option value="ARISS">ARISS</option>
                            <option value="GATE">GATE</option>
                        </select>
                        <button type="submit"
                                class="message-send-button"
                                id="send_msg"
                                aria-label="Send message"
                                disabled>
                            <span class="material-symbols-rounded">send</span>
                        </button>
                    </div>
                </form>
            </div>
        </main>

        <footer class="wc-footer">
            <div class="container-fluid">
                <button class="footer-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#footer-badges-collapse" aria-expanded="false" aria-controls="footer-badges-collapse">
                    <span class="footer-toggle-text">Version Info</span>
                    <span class="material-symbols-rounded footer-toggle-icon">expand_more</span>
                </button>
                <div class="collapse" id="footer-badges-collapse">
                    <div class="footer-badges">
                        <a href="https://badge.fury.io/py/aprsd" target="_blank" rel="noopener">
                            <img src="https://img.shields.io/badge/aprsd-{{aprsd_version}}-darkgreen" alt="APRSD version" height="18">
                        </a>
                        <a href="https://badge.fury.io/py/aprsd-webchat-extension" target="_blank" rel="noopener">
                            <img src="https://img.shields.io/badge/aprsd_webchat_extension-{{version}}-darkgreen" alt="APRSD WebChat version" height="18">
                        </a>
                        <a href="https://github.com/hemna/aprsd-webchat-extension" target="_blank" rel="noopener">
                            <img src="https://img.shields.io/badge/Made%20with-Python-1f425f.svg" alt="Made with Python" height="18">
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </div>
</body>
</html>
